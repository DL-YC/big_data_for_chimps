== Chimpanzee and Elephant Save Christmas ==

It was holiday time at the North Pole, and letters from little boys and little girls all over the world flooded in as they always do. But this year there was a problem: the world had grown, and the elves just couldn't keep up with the scale of requests.

Luckily, their friends at the Chimpanzee & Elephant Computing Company were available to simplify the process.

=== The Need for Locality ===

Santa delivers presents in order as the holidays arrive, racing the sun from New Zealand, through Asia and Africa and Europe, until the finish in American Samoa.

This places a strong demand on *locality*: the presents for Auckland must go in a sack together, and Sydney, and Petropavlovsk, and so forth. To meet the range of asks from children of every corner, each elf is capable of making any kind of toy, from Autobot to Pony to X-box:

image::images/elves_at_workstation-480.jpg[Elf Workstations, pre-Hadoop]

The elves' workbenches are meticulous and neat. Little boys and girls' mail is less so. 

image::images/fetching_a_letter-480.jpg[Fetching the next letter to Santa]

Every time an elf was ready to answer a letter, they would have to swing a big claw arm out into the incoming mail and pull back the letter for their locality. The elf covering Novosibirsk might ask for a new letter right after the elf covering Cucamonga, and that crane can only swing around so fast, so you'd end up with a lot of anxious elves just waiting for letters to be retrieved from the mail store.

=== Letters to Toy Requests ===

The chimps and elephants came in, singing a rather bawdy version of the Map-Reduce Haiku, and built the following system.

In stage one, a finite number of chimpanzees seated at typewriters read each letter and fill out a work form for each requested toy. Some examples:

        --------------------------------------         # Joe is clearly a good kid, and thoughtful for his sister.

        Deer SANTA                                     robot | type="optimus prime" recipient="Joe"
                                                       hat   | type="girls small"  recipient="Joe's sister Julia"
        I wood like an optimus prime robot
        and a hat for my sister julia

        I have been good this year

        love joe


        --------------------------------------          # Frank is a jerk. He will get coal.

        HEY SANTA I WANT A PONY AND NOT ANY             coal  | type="anthracite" recipient="Frank" reason="doesn't like to read"
        DUMB BOOKS THIS YEAR

        FRANK

        ---------------------------------------         # Spam, no action

        Greetings to you Mr Claus, I came to know
        of you in my search for a  reliable and
        reputable person to handle a very confidential
        business transaction, which involves the
        transfer of a huge sum of money...

        ---------------------------------------

image::images/elephant_and_chimpanzee.009-480.jpg[Chimps read each letter]
image::images/elephant_and_chimpanzee.010-480.jpg[Letters become work orders]

=== Order Delivery ===

In the new system, type of toy request -- robot, hat, coal, etc -- is handled by a different set of elves.

image::images/elephant_and_chimpanzee.012-480.jpg[Each toy at a unique station]

A line of pygmy elephants stands near each letter-reading station, one for each type of toy. As the chimp is done with each mailbag, the elephants all trundle off to bring the elves a fresh batch of wishes, and a new line of elephants take their place.

image::images/elephant_and_chimpanzee.048-480.jpg[Work orders go off in batches]

=== Toy Assembly ===

Lastly, the toy wishes come to dedicated workstations:

         ROBOTS               PARCHEESI               COAL
         ROOMBAS              PONIES                  COAL
         RAZOR SCOOTERS       QUIDDITCH BROOMS        SCHOOL SUPPLIES

image::images/elephant_and_chimpanzee.011-480.jpg[Each toy at a unique station]
	 
All wishes for a kind of toy go to the same workstation -- the station that sees wishes for Ponies sees every Pony wish. A station might handle several types of toys in a factory run, but it always sees them in a continuous batch. This is of great help to the elves, as the set-up for tying ribbons on Ponies is very different from the set-up for gift-wrapping Quidditch Brooms.

=== Why it's efficient ===

Now it is still true that each elf workstation has incoming mail from every letter-reader. A constant stream of elephants are constantly dropping off order batches, some light, some heavy, even occasionally a shrug and an empty load. But the delivery isn't harum-scarum all-at-once, it's orderly and purposeful. If one workstation is slow, the elephants wait patiently -- it doesn't slow down the entire operation. And most importantly, all the work of organizing the work requests happens in parallel with reading the letters. It's pretty impressive.

* mail stage is partitioned
* letters have no guaranteed order

* consistent hashing smooths the workload
  - but if it's a great year for Real American Dolls, that workstation can be overloaded. This is the problem of "skew", and we'll talk about this in some detail later.

=== Sorted Batches ===

You may have noticed that something important has been left out: Santa's need for all the gifts to come out in order (locality). The elephants, of course, did not forget; I've just skipped over that part of the story.

Recall that each elephant carries the work orders destined for one workstation. What's more, on the back of each pygmy elephant is a vertical file like you find at a very organized person's desk:

image::images/paper_sorter.jpg[paper sorter]

Chimpanzees file each toy request in the order of Santa's path through the world. This is easy, because the files never grow very large and because chimpanzees are very dextrous. So when a pygmy elephant trundles off, all the `puppy` requests are together in order from Auckland to Samoa, and the `robot` requests are together, also in order, and so on:

image::images/elephant_and_chimpanzee.048-480.jpg[Secondary sort]

This makes life very efficient for the elves. They just start pulling work orders from their elephants, always choosing the request that's next in Santa Visit Order:

image::images/elephant_and_chimpanzee.049-480.jpg[Secondary sort]

Elves do not have the prodigious memory that elephants do, but they can easily keep track of the next few dozen work orders each elephant holds. That way there is very little time spent seeking out the next work order. Elves assemble toys as fast as their hammers can fly, and the toys come out in the order Santa needs to make little children happy. 

JOEMAN:FIN
